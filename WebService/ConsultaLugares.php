<?phpheader('Content-Type: text/html; charset=utf-8');require_once "../lib/nusoap.php";include_once("../WEB-INF/Classes/Catalogo.class.php");include_once("../WEB-INF/Classes/Localidad.class.php");include_once("../WEB-INF/Classes/Cliente.class.php");include_once("../WEB-INF/Classes/Session.class.php");include_once("../WEB-INF/Classes/HistoricoPosiciones.class.php");/** *  * @param type $latitud * @param type $longitud * @param type $radio radio es KM. * @param type $categoria * @param type $pagina */function getLugaresCercanos($latitud, $longitud, $radio, $categoria, $pagina) {    $empresa = 3;    $registros_por_pagina = 10;    $session = new Session();    $session->setEmpresa($empresa);    //$resultadoLoggin = (int)$session->logginWithSession($IdSession);    //if ($resultadoLoggin > 0) {    $catalogo = new Catalogo();    $catalogo->setEmpresa($empresa);    $localidad = new Localidad();    $localidad->setEmpresa($empresa);    $cliente = new Cliente();    $cliente->setEmpresa($empresa);    $historico_posiciones = new HistoricoPosiciones();    $historico_posiciones->setEmpresa($empresa);    $indice = $registros_por_pagina * ($pagina - 1);    /* Obtenemos todos los domicilios ordenados por distancia al punto de la longitud y longitud especificados */    $domicilios_cercanos = $localidad->obtenerDomiciliosCercanos($latitud, $longitud, $categoria, "", $indice, $registros_por_pagina, $radio,"","","");    $busqueda = array();        foreach ($domicilios_cercanos as $key => $value) {        $aux = array();        if ($localidad->getLocalidadById($key)) {            if ($cliente->getRegistroById($localidad->getClaveEspecialDomicilio())) {                $aux['ClaveCliente'] = $cliente->getClaveCliente();                $aux['Nombrecliente'] = $cliente->getNombreRazonSocial();                //$aux['Modalidad'] = $cliente->getModalidad();                $aux['Modalidad'] = 1;                if($cliente->getIdEstatusCobranza() == "2"){                    $aux['Modalidad'] = 3;                }                $aux['DistanciaKm'] = number_format($value,4);                $aux['Latitud'] = $localidad->getLatitud();                $aux['Longitud'] = $localidad->getLongitud();                $direccion = $localidad->getCalle() .                        ", No ext: " . $localidad->getNoExterior() . " No. Int: " . $localidad->getNoInterior() . ", Col: " . $localidad->getColonia() .                        ", Del: " . $localidad->getDelegacion() . ", " . $localidad->getEstado() . ", " . $localidad->getPais() . " C.P.: " . $localidad->getCodigoPostal();                $aux['Direccion'] = $direccion;                $aux['Telefono'] = $cliente->getTelefono();                /* Obtenemos el promedio de las calificaciones del cliente */                $result = $cliente->getCalificacionesCliente(null);                $suma_calis = 0;                $count = 0;                while ($rs = mysql_fetch_array($result)) {                    $suma_calis += (int) $rs['Calificacion'];                    $count++;                }                if ($count > 0) {                    $aux['CalificacionPromedio'] = number_format($suma_calis / $count, 2);                } else {                    $aux['CalificacionPromedio'] = 0;                }                $filename = "";                /* Obtenemos el logo, sino una foto del cliente */                if ($cliente != NULL && $cliente != "") {                    $filename = $cliente->getFoto();                } else {                    $result = $cliente->getCalificacionesCliente(1);                    while ($rs = mysql_fetch_array($result)) {                        $filename = $rs['Foto'];                    }                }                if ($filename != "") {                    $tmpfile = "../" . $filename;   // temp filename                                                                //Buscamos la imagen re-escalada, si no existe, no se envia nada                    $index_last_dot = strrpos($tmpfile, ".");                    $location_aux = substr($tmpfile, 0, $index_last_dot);                    $location_aux .= "resized_300_techra";                    $location_aux .= substr($tmpfile, $index_last_dot);                                        if(!empty($location_aux)){                        $tmpfile = $location_aux;                    }                          if(file_exists($tmpfile)){                        $handle = fopen($tmpfile, "r");                  // Open the temp file                        $contents = fread($handle, filesize($tmpfile));  // Read the temp file                                    fclose($handle);                                 // Close the temp file                        $decodeContent = base64_encode($contents);     // Decode the file content, so that we code send a binary string to SOAP                                    $aux['NombreFoto'] = $filename;                        $aux['Foto'] = $decodeContent;                    }else{                        $cliente_aux['NombreFoto'] = "";                        $cliente_aux['Foto'] = NULL;                    }                } else {                    $aux['NombreFoto'] = $filename;                    $aux['Foto'] = NULL;                }            }        }        array_push($busqueda, $aux);    }        $historico_posiciones->setIdUsuario("NULL");    $historico_posiciones->setLatitud($latitud);    $historico_posiciones->setLongitud($longitud);    $historico_posiciones->setRadio($radio);    //$historico_posiciones->setClaveCliente($ClaveCliente);    if (!empty($categoria)) {        $historico_posiciones->setIdGiro($categoria);    } else {        $historico_posiciones->setIdGiro("NULL");    }    $historico_posiciones->setIdTipoContacto("NULL");    $historico_posiciones->setIdWebService(4);    $historico_posiciones->setPantalla("Lugares Cercanos WS11");    $historico_posiciones->setUsuarioCreacion("");    $historico_posiciones->setUsuarioUltimaModificacion("");    $historico_posiciones->setRespuesta(json_encode(array_values($busqueda)));    $historico_posiciones->newRegistro();    return json_encode(array_values($busqueda));}$server = new soap_server();$server->configureWSDL("consultalugares", "urn:consultalugares");$server->register("getLugaresCercanos", array("latitud" => "xsd:float", "longitud" => "xsd:float", "radio" => "xsd:float",    "categoria" => "xsd:int", "pagina" => "xsd:int"), array("return" => "xsd:string"), "urn:consultalugares", "urn:consultalugares#getLugaresCercanos", "rpc", "encoded", "Obtiene los negocios cercanos a la localización especificada");$server->service($HTTP_RAW_POST_DATA);?>